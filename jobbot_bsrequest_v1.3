#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Fri Aug 30 14:21:55 2019

@author: Tarik
"""

import requests
from bs4 import BeautifulSoup
import pandas as pd
import time
import os

#Demander le(s) mot(s) clés & et le(s) lieu(x)
query = input("Veuillez enter le(s) mot(s) clés pour la recherche: \n").lower()
location = input("Veuillez enter le(s) lieu(x) pour la recherche: \n").upper()


#launch url
url = 'https://candidat.pole-emploi.fr/offres/recherche?lieux={}&motsCles={}&offresPartenaires=true&range=0-9&rayon=10&tri=0'.format(location,query)
base_url="https://candidat.pole-emploi.fr"

#Critères : données + centre val de loire
req = requests.get(url)
soup = BeautifulSoup(req.text, "lxml")

#Nombre d'offres
titre = soup.find('h1', class_ ='title')
nb_offres = int(titre.next_element.replace('\n', '').replace(' offres', ''))



if (nb_offres>150):
    nbpage= (nb_offres//150)+1
    url2=150
else:
    url2=nb_offres
    nbpage=1
url1=0

#Creation de liste
NumOffre=[]
title=[]
Publication=[]
Experiences=[]
Localisation=[]
listeallUrl=[]
Description=[]
Contrat=[]
Horraires=[]
Salaire=[]
Savoirsfaire=[]
Savoir_etre=[]

for i in range(nbpage):
    
    print("------------",i,"---------") 
    
    url='https://candidat.pole-emploi.fr/offres/recherche?lieux={}&motsCles={}&offresPartenaires=true&range='.format(location,query) +str(url1)+'-'+str(url2)+'&rayon=10&tri=0'
    uc=nb_offres-url2
    
    if (uc>150):
        url1+=150
        if (url1==url2):
            url1+=1
        url2+=150
    else:
        url1=url2
        url2=nb_offres
        
    req = requests.get(url)
    soup = BeautifulSoup(req.text, "lxml")
    
    for liens in soup.find_all('h2', class_ ='t4 media-heading'):
        allUrl=(liens.find('a', class_ ='btn-reset')['href'])
        listeallUrl.append(base_url+allUrl)
        offreUrl=base_url+allUrl
        print(base_url+allUrl)
        
        
            
        requete=requests.get(offreUrl)
        soup[i] = BeautifulSoup(requete.text, "lxml")
        
        #print(soup[i])
        #try:
        #Ajout des numéros des offres
        for num_offre in soup[i].find('span', {'itemprop' : 'value'}):
            Offre= num_offre
            #print(num_offre)
            NumOffre.append(num_offre) 
       
        
        #Ajout Titre des annonces
        for titre in soup[i].find_all('h1', {'itemprop' : 'title'}):
            Titre=titre.text.replace('\n', '')
            #print(Titre)
            title.append(Titre)
        

        
        for date in soup[i].find_all('span', {'itemprop' : 'datePosted'}):
            Date=date.next_element.replace('\n', '')
            #print(Date)
            Publication.append(Date)
            
        for experience in soup[i].find_all('span', {'itemprop' : 'experienceRequirements'}):
            exp=experience.next_element.replace('\n', '')
            #print(exp)
            Experiences.append(exp)
        
        for city in soup[i].find('span', {'itemprop' : 'name'}):
            Ville=city
            #print(Ville)
            Localisation.append(Ville)  
   
        try:
            description=soup[i].find("div", {"itemprop": "description"}).get_text()
            #print(description)
            Description.append(description)
        except:
            print("il ya pas de description")            

        try:
            contrat=soup[i].find("dd").get_text()
            print(contrat)
            Contrat.append(contrat)
        except:
            Contrat.append("il ya pas de type de contrat renseigné")
            print("il ya pas de type de contrat renseigné")            

        try:
            contratheures=soup[i].find("dd", {"itemprop": "workHours"}).get_text()
            #print(contratheures)
            Horraires.append(contratheures)
        except:
            Horraires.append("il ya pas de type d'horraires de contrat renseigné")
            print("il ya pas de type d'horraires de contrat renseigné")

        try:
            salaire = soup[i].findAll('dd')[2].text
            s=salaire.replace('\n', '').replace('\xa0', '')
                
            #print(s)
            Salaire.append(s)
        except:
            Salaire.append("il ya pas de salaire renseigné")
            print("il ya pas de salaire renseigné")

        
        sfaire=[]
                      
        for savoirsfaire in soup[i].find_all('span', {'itemprop' : 'skills'}):
               
            sfaire.append(savoirsfaire.text)
        if not sfaire:
            print("il ya pas de savoirsfaire renseigné")
            Savoirsfaire.append("il ya pas de savoirsfaire renseigné")
        else:
            print(sfaire)
            Savoirsfaire.append(sfaire)
            
                

'''
 ul skill-list list-unstyled

for savoiretre in soup.find_all('span', attrs={"class":"skill"})
for qualifications in soup.find_all("span", itemprop={"qualifications"})
for secteuractv in soup.find_all("span", itemprop={"industry"})
for entreprise in soup.find_all('h4', attrs={"class":"t4 title"})
for partenaire in soup.find("a", {"id": "idLienPartenaire"}
'''
        
#pd.set_option("display.colheader_justify","right")
#df = pd.DataFrame({"Numéro de l'offre":NumOffre,"Titre de l'offre":title,"Localisation":Localisation,
#                   "Experiences":Experiences,"Date de publication" : Publication,"Description" : Description,
#                   "Contrat" : Contrat,"Horraires du Contrat" : Horraires,"Salaire" : Salaire,"Savoirsfaire" : Savoirsfaire})
#df.to_csv("pole_emploi.csv", encoding="utf-8") 
#print(df)    
        

    


    








#
#for date in soup.find_all('p', {'class' : 'date'}):
#    Date=date.text.replace('\n', '')
#    print(Date)
#    Publication.append(Date)
#
#for desc in soup.find_all('p', {'class' : 'description'}):
#    print(desc.text.replace('\n', ''))


    
